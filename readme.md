# Сервис транскрибации и суммаризации звонков

## Бизнес-ценность

### Проблема
В крупных компаниях сотрудники ежедневно участвуют в десятках звонков и совещаний. При этом:
- **40% рабочего времени** тратится на встречи и созвоны
- Сотрудники физически не могут присутствовать на всех релевантных встречах
- Важная информация теряется или передается неточно
- Отсутствует единая база знаний по обсуждениям и решениям

### Решение
**CallScribe** — MLOps-сервис, который автоматически:
1. **Транскрибирует** аудио/видео звонки в текст с помощью ASR-модели (Whisper)
2. **Суммаризирует** содержание с выделением ключевых тезисов через LLM
3. **Сохраняет** результаты в структурированном виде для поиска и аналитики

### Ценность для бизнеса
| Метрика | До внедрения | После внедрения |
|---------|--------------|-----------------|
| Время на обработку 1 часа записи | 2-3 часа (ручная расшифровка) | 5-10 минут |
| Охват информации сотрудником | 30-40% встреч | 100% релевантных встреч |
| Поиск информации по прошлым встречам | Затруднен | Мгновенный полнотекстовый поиск |

---

## Функциональные требования (ФТ)

### ФТ-1: Загрузка и обработка аудио/видео файлов
| ID | Требование | Приоритет |
|----|------------|-----------|
| ФТ-1.1 | Система должна принимать аудиофайлы форматов: MP3, WAV, OGG, M4A | Высокий |
| ФТ-1.2 | Система должна принимать видеофайлы форматов: MP4, MKV, WebM | Высокий |
| ФТ-1.3 | Максимальный размер загружаемого файла — 500 МБ | Средний |
| ФТ-1.4 | Система должна извлекать аудиодорожку из видеофайлов автоматически | Высокий |

### ФТ-2: Транскрибация (ASR)
| ID | Требование | Приоритет |
|----|------------|-----------|
| ФТ-2.1 | Система должна преобразовывать речь в текст на русском языке | Высокий |
| ФТ-2.2 | Система должна поддерживать английский язык | Средний |
| ФТ-2.3 | Система должна возвращать транскрипцию с временными метками | Высокий |
| ФТ-2.4 | Точность распознавания (WER) должна быть не хуже 15% на чистых записях | Высокий |

### ФТ-3: Суммаризация (LLM)
| ID | Требование | Приоритет |
|----|------------|-----------|
| ФТ-3.1 | Система должна генерировать краткое саммари звонка (до 500 слов) | Высокий |
| ФТ-3.2 | Система должна выделять ключевые тезисы и решения | Высокий |
| ФТ-3.3 | Система должна определять участников и их основные высказывания | Средний |
| ФТ-3.4 | Система должна формировать список action items (задач) | Средний |

### ФТ-4: Хранение и поиск
| ID | Требование | Приоритет |
|----|------------|-----------|
| ФТ-4.1 | Система должна сохранять транскрипции и саммари в базу данных | Высокий |
| ФТ-4.2 | Система должна обеспечивать полнотекстовый поиск по транскрипциям | Средний |
| ФТ-4.3 | Система должна хранить метаданные: дата, длительность, язык | Высокий |
| ФТ-4.4 | Система должна поддерживать фильтрацию по дате и статусу | Средний |

### ФТ-5: Пользовательский интерфейс
| ID | Требование | Приоритет |
|----|------------|-----------|
| ФТ-5.1 | UI должен позволять загружать файлы через drag-and-drop | Высокий |
| ФТ-5.2 | UI должен отображать статус обработки в реальном времени | Высокий |
| ФТ-5.3 | UI должен показывать историю обработанных файлов | Высокий |
| ФТ-5.4 | UI должен позволять просматривать и копировать результаты | Высокий |
| ФТ-5.5 | UI должен предоставлять аналитическую панель с графиками | Средний |

### ФТ-6: API
| ID | Требование | Приоритет |
|----|------------|-----------|
| ФТ-6.1 | REST API для загрузки файлов (POST /api/v1/transcribe) | Высокий |
| ФТ-6.2 | REST API для получения статуса задачи (GET /api/v1/tasks/{id}) | Высокий |
| ФТ-6.3 | REST API для получения результатов (GET /api/v1/results/{id}) | Высокий |
| ФТ-6.4 | Документация API через Swagger/OpenAPI | Высокий |

---

## Нефункциональные требования (НФТ)

### НФТ-1: Производительность
| ID | Требование | Метрика |
|----|------------|---------|
| НФТ-1.1 | Время обработки 1 минуты аудио | ≤ 30 секунд |
| НФТ-1.2 | Время генерации саммари | ≤ 60 секунд |
| НФТ-1.3 | Пропускная способность системы | ≥ 10 файлов/час |
| НФТ-1.4 | Время отклика API (p95) | ≤ 500 мс |

### НФТ-2: Надежность
| ID | Требование | Метрика |
|----|------------|---------|
| НФТ-2.1 | Доступность сервиса (Uptime) | ≥ 99% |
| НФТ-2.2 | Сохранность данных при сбоях | 100% (персистентное хранилище) |
| НФТ-2.3 | Автоматический перезапуск при падении | Docker restart policy |
| НФТ-2.4 | Graceful degradation при недоступности LLM | Возврат только транскрипции |

### НФТ-3: Масштабируемость
| ID | Требование | Описание |
|----|------------|----------|
| НФТ-3.1 | Горизонтальное масштабирование воркеров | Через Kafka consumer groups |
| НФТ-3.2 | Независимое масштабирование ASR и LLM | Раздельные сервисы |
| НФТ-3.3 | Поддержка очереди задач | До 1000 задач в очереди |

### НФТ-4: Безопасность
| ID | Требование | Описание |
|----|------------|----------|
| НФТ-4.1 | Валидация входных файлов | Проверка MIME-type и размера |
| НФТ-4.2 | Изоляция сервисов | Docker network isolation |
| НФТ-4.3 | Отсутствие хардкода секретов | Использование .env файлов |

### НФТ-5: Мониторинг и наблюдаемость
| ID | Требование | Описание |
|----|------------|----------|
| НФТ-5.1 | Сбор метрик приложения | Prometheus metrics endpoint |
| НФТ-5.2 | Визуализация метрик | Grafana dashboards |
| НФТ-5.3 | Логирование событий | Structured logging (JSON) |
| НФТ-5.4 | Алертинг при критических ошибках | Grafana alerts |

### НФТ-6: Воспроизводимость
| ID | Требование | Описание |
|----|------------|----------|
| НФТ-6.1 | Запуск одной командой | docker-compose up |
| НФТ-6.2 | Фиксация версий зависимостей | requirements.txt с версиями |
| НФТ-6.3 | Документация по развертыванию | README.md с инструкциями |
| НФТ-6.4 | Версионирование моделей | DVC или аналог |

---

## Архитектура

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CallScribe Architecture                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────┐     ┌──────────────┐     ┌─────────────────────────────────┐  │
│  │          │     │              │     │           Kafka                 │  │
│  │  Streamlit│────▶│   FastAPI    │────▶│  ┌─────────┐  ┌─────────────┐  │  │
│  │    UI    │     │   Gateway    │     │  │ audio   │  │ transcription│  │  │
│  │          │◀────│              │◀────│  │ -topic  │  │    -topic    │  │  │
│  └──────────┘     └──────────────┘     │  └─────────┘  └─────────────┘  │  │
│                          │             └──────┬──────────────┬──────────┘  │
│                          │                    │              │              │
│                          ▼                    ▼              ▼              │
│                   ┌──────────────┐     ┌──────────┐   ┌──────────┐         │
│                   │              │     │  ASR     │   │   LLM    │         │
│                   │  PostgreSQL  │◀────│  Worker  │   │  Worker  │         │
│                   │              │     │ (Whisper)│   │(Summarize)│         │
│                   └──────────────┘     └──────────┘   └──────────┘         │
│                          │                                                  │
│                          ▼                                                  │
│                   ┌──────────────┐     ┌──────────────┐                    │
│                   │  Prometheus  │────▶│   Grafana    │                    │
│                   │              │     │  Dashboards  │                    │
│                   └──────────────┘     └──────────────┘                    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Компоненты системы

| Компонент | Технология | Назначение |
|-----------|------------|------------|
| **UI** | Streamlit | Веб-интерфейс для загрузки файлов и просмотра результатов |
| **API Gateway** | FastAPI | REST API, валидация, маршрутизация запросов |
| **Message Broker** | Kafka | Асинхронная очередь задач на обработку |
| **ASR Worker** | Whisper (OpenAI) | Транскрибация аудио в текст |
| **LLM Worker** | LLaMA/Mistral | Суммаризация и извлечение ключевых тезисов |
| **Database** | PostgreSQL | Хранение транскрипций, саммари, метаданных |
| **Monitoring** | Prometheus + Grafana | Сбор и визуализация метрик |

---

## Технологический стек

### Backend
- **Python 3.10+** — основной язык разработки
- **FastAPI** — высокопроизводительный веб-фреймворк
- **Pydantic** — валидация данных
- **SQLAlchemy** — ORM для работы с БД

### ML/AI
- **Whisper** (OpenAI) — ASR модель для транскрибации
- **Transformers** (HuggingFace) — работа с LLM моделями
- **FFmpeg** — обработка аудио/видео файлов

### Infrastructure
- **Docker & Docker Compose** — контейнеризация
- **Kafka** — брокер сообщений
- **PostgreSQL** — реляционная СУБД
- **Redis** — кэширование (опционально)

### Monitoring & Logging
- **Prometheus** — сбор метрик
- **Grafana** — визуализация и алертинг
- **Python logging** — структурированное логирование

### Frontend
- **Streamlit** — интерактивный веб-интерфейс

### Запуск

```bash
# Клонирование репозитория
git clone https://github.com/kdimon15/project_mlops.git
cd project_mlops

# Копирование конфигурации
cp .env.example .env

# Запуск всех сервисов
docker-compose up -d

# Проверка статуса
docker-compose ps
```

### Доступ к сервисам

| Сервис | URL | Описание |
|--------|-----|----------|
| **UI** | http://localhost:8501 | Веб-интерфейс Streamlit |
| **API** | http://localhost:8000 | FastAPI backend |
| **Swagger** | http://localhost:8000/docs | API документация |
| **Grafana** | http://localhost:3000 | Мониторинг (admin/admin) |

---

## API документация

### Основные эндпоинты

#### Загрузка файла на обработку
```http
POST /api/v1/transcribe
Content-Type: multipart/form-data

file: <audio/video file>
language: ru (optional, default: auto)
```

**Response:**
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "queued",
  "created_at": "2025-12-12T18:00:00Z"
}
```

#### Получение статуса задачи
```http
GET /api/v1/tasks/{task_id}
```

**Response:**
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "completed",
  "progress": 100,
  "created_at": "2025-12-12T18:00:00Z",
  "completed_at": "2025-12-12T18:05:00Z"
}
```

#### Получение результатов
```http
GET /api/v1/results/{task_id}
```

**Response:**
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "transcription": "Полный текст транскрипции...",
  "summary": "Краткое содержание звонка...",
  "key_points": [
    "Обсудили план на Q1",
    "Решили увеличить бюджет на маркетинг"
  ],
  "action_items": [
    "Подготовить презентацию к понедельнику",
    "Отправить отчет клиенту"
  ],
  "duration_seconds": 3600,
  "language": "ru"
}
```

---

## Мониторинг

### Grafana Dashboards

После запуска доступны следующие дашборды:

1. **System Overview** — общее состояние системы
   - Количество обработанных файлов
   - Средняя длительность обработки
   - Размер очереди задач

2. **ML Metrics** — метрики ML-моделей
   - Время инференса ASR
   - Время генерации саммари
   - Распределение по языкам

3. **Business Metrics** — бизнес-метрики
   - Количество запросов в час
   - Топ пользователей
   - Объем обработанного аудио

### Prometheus Metrics

```
# Количество обработанных файлов
callscribe_files_processed_total

# Время обработки (гистограмма)
callscribe_processing_duration_seconds

# Размер очереди
callscribe_queue_size

# Ошибки
callscribe_errors_total
```

---

## 📁 Структура проекта

```
project_mlops/
├── docker-compose.yml          # Оркестрация контейнеров
├── .env.example                # Пример переменных окружения
├── readme.md                   # Документация проекта
├── one-pager.pdf              # Краткое описание проекта
│
├── api/                       # FastAPI приложение
│   ├── Dockerfile
│   ├── requirements.txt
│   ├── main.py
│   └── routers/
│
├── workers/                   # ML воркеры
│   ├── asr/                   # Whisper транскрибация
│   │   ├── Dockerfile
│   │   └── worker.py
│   └── llm/                   # LLM суммаризация
│       ├── Dockerfile
│       └── worker.py
│
├── ui/                        # Streamlit интерфейс
│   ├── Dockerfile
│   ├── requirements.txt
│   └── app.py
│
├── monitoring/                # Мониторинг
│   ├── prometheus/
│   │   └── prometheus.yml
│   └── grafana/
│       └── dashboards/
│
└── docs/                      # Дополнительная документация
    └── architecture.drawio
```